---
title: 通用常驻 Agent（极简内核 + Skills 扩展）— 产品与架构设计
status: draft
owner: product+architecture
---

# 通用常驻 Agent（极简内核 + Skills 扩展）— 产品与架构设计

> 本文是“特性设计/整体设计定盘”，刻意不绑定具体代码实现、语言、依赖库与部署形态。
> 目标是让后续工程实现时“只做选择题”，不再重新争论方向。

## 1. 背景与问题

当前项目的出发点偏“投资/回测”。但用户需求更本质的是：做一个类似 OpenClaw / Claude Code 的 **通用常驻 Agent**：

- 能长期运行、持久化、恢复（用户活动跨月/跨年）
- 能形成 Memory（人格、偏好、历史行动/产物索引）
- 能在 IM（Telegram/Discord 等）与 CLI 上统一对话
- 能通过 Skills 扩展能力，内核保持极简
- 能有 Subagent（静态与动态）用于并行/隔离
- 能有 Scheduler（定时/周期/事件），并支持自然语言创建任务（先设计稿，后确认）

关键纠偏：**“投资能力”应是默认能力包（提示词 + 可选技能/工具），而不是内核身份。**

### 1.1 参考与借鉴（从 OpenClaw / Claude Code 学什么，不学什么）

这次重构的“方向盘”来自两类成熟实践，但我们刻意只借鉴可迁移的抽象：

- 从 **OpenClaw** 借鉴：
  - 常驻运行 + 多渠道接入的产品形态（“你在常用频道里就能用”）
  - 内核保持精简、能力主要由插件/技能扩展的治理思路
  - 安全默认与显式授权（尤其面对 IM 的不可信输入）
- 从 **Claude Code** 借鉴：
  - Skills 的产品语义：按需加载、可控调用、权限声明、可 fork 到子代理
  - Workspace/Memory 的“可编辑、可审计、渐进注入”思路

明确不照抄的部分：
- 不复制“重网关 + 巨量配置面”的复杂度（我们先做单用户闭环，再做多用户/多端治理）
- 不把领域能力（投资/回测/新闻等）做进内核（以 skills/外部工具提供者承载）

## 2. 产品定位（North Star）

一句话：**一个你自己运行的常驻助手**，能在你常用的沟通渠道里协作；像受过良好教育的助理一样使用“工作目录（workspace）”做记录、产出文档、执行任务；复杂能力通过 Skills 组合生长。

### 2.1 典型使用场景（通用，不绑定投资）

- 长期项目助理：跨多周持续跟进，按计划自动提醒、汇总进展、生成周报
- 个人知识助理：把重要约定/偏好写入可编辑的 Memory，按需回忆
- 研究助理：开子代理并行搜集信息（或在本地文件中整理），最后由主代理汇总成报告
-（可选能力包）投资研究助理：生成研究框架、复盘、提醒、报告模板；不默认“自动交易”

### 2.2 非目标（防止内核膨胀）

- 不在内核里做领域专用数据结构（如“持仓表/投资账本/交易系统”）
- 不把特定数据源/券商/财经新闻等变成内核依赖
- 不把复杂多层“经理-经理-经理”式编排树作为默认架构（可由某些 skills 自行采用）
- 不把高风险外部动作默认自动化（必须强确认与权限隔离）

### 2.3 用户画像与默认范围（Personas & Defaults）

默认优先服务“你自己的常驻助理”（单用户、强个性化）：

- **个人用户（默认）**：有长期目标/项目，需要一个能记住约定、能自动提醒、能产出文档的助理。
- **小团队（后续）**：多个成员在同一群组/频道里协作，需要更严格的权限、会话隔离与审计。

默认范围选择（避免一开始就复杂）：

- 默认单用户、多会话（不同群/线程）隔离
- 默认本地优先（workspace + memory 可读可编辑），外部服务作为可选扩展
- 默认“建议/协作”而非“自动执行高风险动作”

### 2.4 成功标准（Success Criteria / 产品验收口径）

不以“功能数量”作为成功，而以以下结果作为成功：

- **可用性**：能稳定常驻，崩溃恢复后不丢任务与关键记忆
- **可控性**：用户能看懂、能编辑、能撤销 agent 的长期记忆与自动化
- **可扩展性**：复杂能力主要通过 skills 迭代，不需要持续改内核
- **安全性**：默认不越权、不乱发、不做高风险动作；高风险动作必经确认与审计

## 3. 设计原则（克制、优雅、整洁、可扩展）

1. **内核极小化**：内核只提供稳定原语（primitives）；功能通过 skills 组合扩展。
2. **文件即工作台**：workspace 是“助理的笔记本与产出仓库”，长期信息优先落地为人可读文件。
3. **渐进式上下文**：默认注入索引/摘要；需要时再加载细节，避免上下文膨胀。
4. **安全默认拒绝**：高风险动作、跨会话操作、敏感数据输出默认需要显式确认。
5. **可审计**：关键决策、工具调用、任务触发都有事件日志与产物文件可追溯。
6. **渠道无关**：Telegram/Discord/CLI 都是适配器；会话、任务、skills 的语义一致。

### 3.1 关键取舍（自我批评：我们刻意不走的“看似更强”的路）

以下做法短期看起来“更完整”，长期会把系统做死，因此明确不作为默认：

- **把领域模型做进内核**（例如“投资账本/持仓系统/交易建议专用存储”）：
  - 结果：内核不可避免地被某个领域绑架，其他场景都变成二等公民。
  - 替代：让 skill 用 workspace 像“助理写笔记”一样记录一切。
- **把大量工具内置到内核**：
  - 结果：维护成本指数上升；安全边界变糊；用户无法理解“它到底能做什么”。
  - 替代：内核只保留极少稳定原语；其余能力通过 skills/外部工具提供者扩展。
- **默认自动化执行高风险动作**（尤其资金相关）：
  - 结果：一次误触发即可造成不可逆损失，且难以复盘归因。
  - 替代：高风险动作必须是显式启用的 skill，并且强确认、强审计。

## 4. 核心概念模型（统一语言，减少歧义）

### 4.1 7 个原语（Primitives）

1. **Turn**：一次输入 → 推理 → 调用/产出 → 回复的最小单位（来源：IM/CLI/定时器/事件）。
2. **Session**：会话容器；对不同 channel/thread/user 做隔离与映射。
3. **Workspace**：工作目录（文件集合）；是 agent 的“笔记本 + 产出仓库”。
4. **Memory**：长期稳定的“事实/偏好/规则/索引”，可编辑、可回滚；本质上仍落地在 workspace。
5. **Tool**：可执行能力接口（读写文件、发消息、运行计算、调用外部服务等）。
6. **Skill**：按需加载的“局部工作流/指令包”，用于组织、约束、复用工具；可声明权限与运行方式。
7. **Task**：可持久化的自动触发 Turn（cron/interval/event），带状态、重试与告警策略。

### 4.2 Skill 与 Tool 的边界（必须澄清）

- Tool = 能力接口（做一件事）
- Skill = 工作流与约束（怎么把多件事组织成一件“可复用的事”）

Skill 的价值不在“增加内核能力”，而在：
- **模块化**：复杂能力拆成可维护单元
- **可控与隔离**：声明允许的工具与运行上下文（例如 fork 子代理）
- **按需加载**：默认只暴露简短描述，调用时才加载正文，减少上下文污染

## 5. 功能特性定盘（MVP → 可演进）

### 5.1 常驻运行与恢复（Always-on + Recovery）

能力定义：
- 进程常驻：可前台运行，也可后台服务化（不在本文限定实现方式）
- 崩溃恢复：重启后恢复会话、任务状态；避免重复副作用（幂等）
- 升级可控：升级/重启不会丢失关键 Memory 与任务定义

验收口径（行为）：
- 进程重启后，任务仍会按计划触发；会话仍能延续正确的上下文
- 同一个任务重复触发时，默认不会重复发送同一条通知/重复生成同一份产物（除非用户允许）

### 5.2 Memory（长期关系的核心）

Memory 的内容类型（通用）：
- 人格与工作方式（语气、偏好、默认输出结构）
- 用户偏好与约束（语言、格式、隐私要求、风险偏好等）
- 长期项目上下文（“我们在做什么、关键约定是什么”）
- 历史产物索引（报告/决策/清单在哪里）

写入策略（克制）：
- 默认“谨慎写入”：只写稳定、反复出现、已确认的信息
- 不确定/可能过期的信息写成带时间戳的 notes，而不是“永恒事实”
- 必须提供：查看、编辑、撤销（避免记错后长期污染）

### 5.3 Channels（IM + CLI）

统一抽象：
- 输入：消息（文本/附件/引用/线程信息/发送者身份）
- 输出：回复（分段发送、长文落文件后发摘要、可静默）

MVP 建议：
- CLI（必须）
- IM 先实现一个作为样板（Telegram 或 Discord），后续通过 adapter 扩展

### 5.4 Skills（扩展能力的唯一主路径）

本项目采用与 Claude Code “技能按需加载”一致的产品语义（不要求照抄实现）：

- **默认上下文只注入 skill 的摘要/元信息**，正文在调用时加载
- 支持两种调用：
  - 用户显式调用（类似 `/skill-name ...`）
  - 模型自动调用（可配置禁用）
- Skill 可声明：
  - `allowed-tools`：允许使用哪些工具（权限边界）
  - `disable-model-invocation`：禁止模型自动触发（只允许用户显式调用）
  - `user-invocable`：是否暴露给用户菜单
  - `context: fork`：是否必须在子代理中运行（隔离）

推荐的 skill 交付形态（概念示例）：

- 以目录为单位：`.claude/skills/<skill-name>/`
- 入口文件：`SKILL.md`（元信息 + 工作流指令 + 可选模板/资源）
- 元信息至少包含：`description`、`allowed-tools`、`disable-model-invocation`、`user-invocable`、`context`

（示例片段，字段名可在实现阶段确定，但语义需保持一致）
```yaml
---
description: 把输入资料整理为要点并给出引用
allowed-tools: [workspace.read, workspace.write, subagents.run]
context: fork
disable-model-invocation: false
user-invocable: true
---
```

**强约束（避免“形同虚设”）：**
- 如果模型能用“通用文件读取工具”直接读到 skills 目录内容，那么 `disable-model-invocation`、`allowed-tools` 会被绕过。
- 因此内核必须在工具层面保证：skills 内容只能通过 Skill Engine 受控加载，而不是任意 workspace 读文件即可触达。

Skill 的产品治理（MVP 需预留，Phase 2 做强）：
- 技能来源：本地/私有仓库/未来市场（不限定形态，但必须可追溯）
- 生命周期：安装 → 启用/禁用 → 升级/回滚
- 可见性：是否对用户暴露（菜单/帮助），是否允许模型自动调用
- 权限：声明 `allowed-tools`；未声明不得调用高风险工具

### 5.5 Subagents（静态 + 动态）

目的：
- 并行：加速探索（多路研究/对比）
- 隔离：对高风险/高不确定任务做“沙盒执行”

类型：
- 静态子代理：预置角色（研究员/审稿人/风险官/计划员）
- 动态子代理：按需生成专项分身（“只负责收集资料并列出处”）

约束：
- 子代理上下文更少（最小泄露）
- 子代理工具更少（最小风险）
- 子代理输出必须可汇总（结构化要点 + 指向 workspace 产物）

### 5.6 Scheduler（自然语言创建定时任务）

核心交互（必须）：
1) 用户用自然语言描述意图
2) agent 先生成“任务设计稿”（触发条件、频率、输入、产物、通知、失败策略）
3) 用户确认后才落地为 Task

任务类型（通用）：
- 定时：cron / interval
- 事件：消息关键词、文件变更、webhook（MVP 可先不做，但模型与接口需预留）

输出策略：
- 默认写入 workspace 产物文件，并在 IM/CLI 发送摘要（可带路径/引用）
- 支持静默任务：只写文件不打扰；异常才通知

## 6. Workspace 设计（必要 vs 非必要）

目标：**只规定最小必需项**；其他目录与文件由 skills 在需要时创建。

### 6.1 推荐的最小工作区（仅 3 个必需项）

```
agent.md
memory/
  MEMORY.md
.claude/
  skills/
    <skill-name>/
      SKILL.md
      ... (可选资源文件)
```

- `agent.md`：该 agent 的“宪法”（人格、边界、默认风格、禁止事项）。短、稳定、可审计。
- `memory/MEMORY.md`：记忆索引（高层摘要 + 指向详细文件）。默认只注入前 N 行或指定段落，避免膨胀。
- `.claude/skills/`：skills 仓库，支持“按需加载 + 权限声明”的技能形态。

### 6.2 非必需（但可由 skill 创建/维护）

- `notes/`：随手记录、时间戳观察
- `reports/`：可发布报告、复盘
- `tasks/`：任务设计稿与运行日志
- `artifacts/`：图片、表格、导出文件

原则：这些目录不写进“内核契约”，避免把某个领域的工作流强行变成所有用户的默认负担。

### 6.3 命名与职责边界（避免把“开发说明”混进“运行时工作区”）

为了让用户与实现者都不困惑，明确区分两类文件：

- **运行时工作区（workspace）文件**：面向用户与 agent 协作（如 `agent.md`、`memory/`、产出报告/笔记）。
- **仓库开发说明文件**：面向开发/贡献流程（如 `CLAUDE.md`、`AGENTS.md`、工程规范等）。

本设计的约定是：
- `agent.md` 作为运行时“宪法/自我描述”文件（强相关、可编辑、可审计）。
- `CLAUDE.md`/`AGENTS.md` 若存在，属于“代码仓库说明”，不默认注入到运行时对话上下文；避免把开发约束误当成用户需求。

## 7. 内核架构（概念级，不绑定实现）

### 7.1 模块划分（概念）

1. **Runtime/Daemon**：常驻循环、信号处理、健康检查、升级/重启策略
2. **Channel Adapters**：Telegram/Discord/CLI 输入输出适配
3. **Session Manager**：会话隔离、身份映射、上下文裁剪
4. **Memory Manager**：记忆写入/读取策略、索引维护、可编辑/回滚
5. **Skill Engine**：技能发现、摘要注入、调用时加载、权限/上下文约束执行
6. **Tool Router**：统一工具调用入口（审批/审计/限流/重试）
7. **Scheduler**：任务存储、触发、重试、静默策略、告警
8. **Subagent Runner**：fork 上下文、限制工具、汇总输出

### 7.2 内核工具面（必须收敛）

建议将内核工具收敛到少数稳定原语（示意）：
- `workspace.*`：在允许范围内读写 workspace（但不能直接读取 skills 内容）
- `skills.*`：列出/调用 skills（受控加载 + 权限执行）
- `tasks.*`：创建/暂停/恢复/查询任务
- `subagents.*`：创建/运行子代理并汇总
- `messaging.*`：向 channel 发送消息（带限速/分段/引用）

其他复杂能力（市场数据、新闻、回测、报表生成等）全部走 skills + 外部工具提供者，避免内核膨胀。

## 8. 安全与合规（产品必须前置的护栏）

1. **IM 输入默认不可信**：必须有 prompt injection 防护与规则优先级。
2. **高风险动作强确认**：外部副作用（发送敏感信息、跨会话操作、资金相关）默认需要确认。
3. **权限最小化**：skills 声明 allowed-tools；未声明不得调用高风险工具。
4. **审计与可追溯**：任务触发、工具调用、关键决策都产生日志与产物链接。

（投资能力包建议默认附加声明：研究与建议用途；若接入真实交易执行，必须作为高风险 skill，默认关闭。）

### 8.1 可观测性与审计（Observability）

为了“长期可用 + 可控 + 可复盘”，MVP 需具备最小审计面：

- **事件日志**：记录 Turn / Task 触发 / Tool 调用 / Skill 调用 / Subagent 调用的关键字段（时间、来源、目标、结果、错误）。
- **产物可追溯**：所有报告/清单/笔记都能从 memory 索引或“最近产物”列表找到。
- **失败可诊断**：定时任务失败有清晰错误与重试策略；必要时通知用户（静默任务也要在失败时可见）。

## 9. 交互与管理体验（让“长期助手”可被管理）

原则：自然语言是入口，但不能取消可控性。

推荐的统一管理能力（CLI 与 IM 语义一致）：
- 查看/调用 skills（显式调用优先，自动调用可开关）
- 查看/编辑/撤销 memory
- 创建/查看/暂停/恢复 tasks（自然语言 → 任务设计稿 → 用户确认）
- 查看最近产物与审计记录（“上次你做了什么/写了什么”）

### 9.1 关键用户旅程（示例）

旅程 A：自然语言创建定时任务（先设计后确认）
1) 用户：“每周五收盘后，帮我总结本周工作进展并生成周报。”
2) Agent 输出“任务设计稿”：频率、触发时间、输入来源（workspace 中哪些文件）、产物路径、通知方式、失败重试与静默策略。
3) 用户：“确认执行。”
4) 系统创建 Task；每次触发生成 `reports/weekly/YYYY-MM-DD.md` 并发送摘要。

旅程 B：显式调用 skill
1) 用户：“/research 把这份资料整理成要点，给出引用。”
2) Skill 在受限工具集下运行（必要时 fork 子代理），产出 `notes/research/...`；主对话只回摘要与下一步建议。

## 10. 交付路线（避免一口吃成胖子）

### Phase 1（MVP：能常驻、能记、能扩展、能定时）
- CLI + 1 个 IM adapter
- Workspace 三件套（`agent.md` / `memory/` / `.claude/skills/`）
- Skill Engine（按需加载 + 权限约束）
- Scheduler（设计稿 → 确认 → 执行）
- Subagent（fork + 汇总）

### Phase 2（可用性与生态）
- 多 IM adapters
- skills 安装/启用/禁用/版本治理体验
- 记忆治理增强（冲突、过期、回滚、摘要策略）
- 触发器扩展（事件/webhook）

### Phase 3（能力包生态，仍不入内核）
- 投资能力包（研究/复盘/提醒/报告模板）
- 开发能力包、写作能力包等

## 11. 验收标准（BDD 风格行为用例）

建议把下列行为写成可执行规格（Feature/Scenario），避免实现时跑偏：

1. **恢复**：进程崩溃后重启，任务仍按计划触发；会话不丢关键记忆。
2. **记忆**：用户确认的信息会被记住；撤销后不会继续引用。
3. **技能权限**：未授权工具的 skill 不能越权；被禁用 skill 不会被自动调用。
4. **定时任务**：自然语言创建任务必须先产出“任务设计稿”并等待确认；触发后生成产物并发送摘要。
5. **子代理**：子代理输出被主代理汇总为可执行清单/结论，并写入 workspace。

[PROTOCOL]: 变更时更新此头部，然后检查 CLAUDE.md
